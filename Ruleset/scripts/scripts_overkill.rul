extended:
  tags:
    BattleUnit:
      UNIT_OVERKILL_DISABLE_SELF_DESTRUCT: int #is our self-destruct disabled?
    RuleArmor:
      ARMOR_DISABLE_OVERKILL_SELF_DESTRUCT: int #do we disable our self-destruct if the unit is overkilled?

  scripts:
    damageUnit:
      - new: ROSIGMA_dU_overkill
        offset: 98
        code: |
          var int health;
          var int temp;
          var int difference;
          var int check;
          var int multiplier;
          var ptr RuleArmor rArmor;

          if eq damaging_type 2;
            set check 1;
            set multiplier 3;
          end;
          if eq damaging_type 3;
            set check 1;
            set multiplier 2;
          end;
          if eq damaging_type 5;
            set check 1;
            set multiplier 2;
          end;
          if eq damaging_type 11;
            set check 1;
            set multiplier 4;
          end;

          if eq check 1;
            unit.getHealth health;
            if gt to_health health;

              set difference to_health;
              sub difference health;
              mul difference multiplier;
              mul difference -1;
              #debug_log difference;
              unit.setHealthWithOverkill difference;
            end;
          end;

          unit.getRuleArmor rArmor;
          rArmor.getTag temp Tag.ARMOR_DISABLE_OVERKILL_SELF_DESTRUCT; #if overkill stops us our scripted forced self-destruct, set the tag appropriately as follows
          if lt temp 1;
            #debug_log "ROSIGMA_dU_overkill Scripts; damageUnit, offset 99: Aborting. Target has no disable self-destruct on kill:" temp;
            return;
          end;

          unit.getHealth health;
          unit.getHealthMax temp;
          div temp 2;
          mul temp -1;
          if le health temp; #if we are overkilled, set the tag to disable forced self-destruct
            unit.setTag Tag.UNIT_OVERKILL_DISABLE_SELF_DESTRUCT 1;
          end;

          return;

